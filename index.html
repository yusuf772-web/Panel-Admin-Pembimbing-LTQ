<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin Pembimbing</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }

        .card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
        }

        .form-input, .form-select {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.625rem 1rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1f2937, 0 0 0 4px #3b82f6;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }
        .btn-primary:disabled {
            background-color: #374151;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-secondary {
            background-color: #4b5563;
            color: #d1d5db;
        }
        
        .toast {
            position: fixed; top: 1.25rem; right: 1.25rem; color: white;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transform: translateX(120%); transition: transform 0.3s ease-in-out; z-index: 100;
        }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        <!-- Header -->
        <header class="flex items-center gap-4">
            <div class="bg-blue-600 p-3 rounded-lg">
                <i data-lucide="sliders-horizontal" class="w-8 h-8 text-white"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-white">Panel Admin Pembimbing</h1>
                <p class="text-gray-400">Kelola periode rekapitulasi dan tanggal libur.</p>
            </div>
        </header>

        <!-- Manage Recap Periods -->
        <div class="card p-6">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
                <h2 class="text-xl font-semibold text-white">Kelola Periode Rekap</h2>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <select id="monthFilter" class="form-select flex-grow">
                        <!-- Options will be dynamically generated by JavaScript -->
                    </select>
                    <select id="yearFilter" class="form-select w-24">
                        <!-- Options will be dynamically generated by JavaScript -->
                    </select>
                    <button id="setFilterBtn" type="button" class="btn btn-secondary flex-shrink-0">Setel</button>
                </div>
            </div>
            <div class="space-y-4">
                <form id="addPeriodForm" class="space-y-3 p-4 bg-gray-900/50 rounded-lg">
                    <input type="hidden" id="periodId">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="periodStartDate" class="text-sm font-medium">Tanggal Mulai</label>
                            <input type="date" id="periodStartDate" class="form-input mt-1" required>
                        </div>
                        <div>
                            <label for="periodEndDate" class="text-sm font-medium">Tanggal Akhir</label>
                            <input type="date" id="periodEndDate" class="form-input mt-1" required>
                        </div>
                    </div>
                    <button type="submit" id="addPeriodBtn" class="btn btn-primary w-full">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                        <span>Setel Periode</span>
                    </button>
                </form>
                <div>
                    <h3 class="font-semibold mt-4">Daftar Periode Tersimpan</h3>
                    <div id="periodsListContainer" class="mt-2 space-y-2 max-h-64 overflow-y-auto p-2 bg-gray-900 rounded-md">
                        <p class="text-gray-500 text-center">Memuat periode...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Manage Holidays -->
        <div class="card p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Kelola Tanggal Libur</h2>
            <div class="space-y-4">
                <div class="flex flex-col sm:flex-row gap-4 mb-2 items-center">
                    <input type="date" id="newHolidayDate" class="form-input flex-grow">
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="holidayMorning" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 mr-2"> 
                            <span class="text-sm text-gray-300">Pagi</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="holidayAfternoon" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 mr-2"> 
                            <span class="text-sm text-gray-300">Sore</span>
                        </label>
                    </div>
                    <button id="addHolidayBtn" type="button" class="btn btn-secondary flex-shrink-0">Tambah</button>
                </div>
                <div id="holidaysListContainer" class="p-2 bg-gray-900 rounded-md space-y-2 max-h-48 overflow-y-auto">
                     <p class="text-gray-500 text-center">Memuat tanggal libur...</p>
                </div>
                <div class="text-right mt-2">
                    <button id="saveHolidaysBtn" type="button" class="btn btn-primary">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        <span>Simpan Tanggal Libur</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <p id="toastMessage"></p>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, setDoc, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBzvOsp5EVnzTI8Kbew9nXSXXLpakBD6Ec",
            authDomain: "ltq-hn.firebaseapp.com",
            projectId: "ltq-hn",
            storageBucket: "ltq-hn.appspot.com",
            messagingSenderId: "542731528480",
            appId: "1:542731528480:web:15203f68716ed2e3dacf45"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let allPeriods = [];
        let allHolidays = []; // Store all holidays globally
        let currentUserId = null;
        let unsubscribes = {};

        // --- DOM Elements ---
        const dom = {
            addPeriodForm: document.getElementById('addPeriodForm'),
            periodId: document.getElementById('periodId'),
            periodStartDate: document.getElementById('periodStartDate'),
            periodEndDate: document.getElementById('periodEndDate'),
            addPeriodBtn: document.getElementById('addPeriodBtn'),
            periodsListContainer: document.getElementById('periodsListContainer'),
            monthFilter: document.getElementById('monthFilter'),
            yearFilter: document.getElementById('yearFilter'),
            setFilterBtn: document.getElementById('setFilterBtn'), // New DOM element for Set button
            newHolidayDate: document.getElementById('newHolidayDate'),
            holidayMorning: document.getElementById('holidayMorning'),
            holidayAfternoon: document.getElementById('holidayAfternoon'),
            holidaysListContainer: document.getElementById('holidaysListContainer'),
            addHolidayBtn: document.getElementById('addHolidayBtn'),
            saveHolidaysBtn: document.getElementById('saveHolidaysBtn'),
        };

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                fetchInitialData();
            } else {
                try { await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth)); } 
                catch (error) { console.error("Authentication error:", error); }
            }
        });

        // --- Data Fetching ---
        function fetchInitialData() {
            populateMonthAndYearFilters(); // Populate filters and load saved values

            const periodsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'recapPeriods');
            unsubscribes.periods = onSnapshot(periodsCollection, (snapshot) => {
                allPeriods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPeriodsList(); // Re-render periods after data changes
            });

            const holidayDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'holidays');
            unsubscribes.holidays = onSnapshot(holidayDocRef, (docSnap) => {
                allHolidays = docSnap.exists() ? docSnap.data().dates || [] : [];
                renderHolidaysList(); // Re-render holidays after data changes
            });
        }

        // --- UI Rendering ---
        function populateMonthAndYearFilters() {
            const currentYear = new Date().getFullYear();
            const months = [
                "Januari", "Februari", "Maret", "April", "Mei", "Juni",
                "Juli", "Agustus", "September", "Oktober", "November", "Desember"
            ];
            
            let monthOptionsHtml = '<option value="">Semua Bulan</option>';
            months.forEach((month, index) => {
                monthOptionsHtml += `<option value="${String(index).padStart(2, '0')}">${month}</option>`;
            });
            dom.monthFilter.innerHTML = monthOptionsHtml;

            let yearOptionsHtml = '<option value="">Semua Tahun</option>';
            for (let yearOffset = -5; yearOffset <= 5; yearOffset++) {
                const year = currentYear + yearOffset;
                yearOptionsHtml += `<option value="${year}">${year}</option>`;
            }
            dom.yearFilter.innerHTML = yearOptionsHtml;

            // Load saved filter settings from localStorage
            const savedMonth = localStorage.getItem('selectedMonthFilter');
            const savedYear = localStorage.getItem('selectedYearFilter');

            if (savedMonth) {
                dom.monthFilter.value = savedMonth;
            } else {
                dom.monthFilter.value = String(new Date().getMonth()).padStart(2, '0');
            }

            if (savedYear) {
                dom.yearFilter.value = savedYear;
            } else {
                dom.yearFilter.value = currentYear.toString();
            }
        }

        function renderPeriodsList() {
            const container = dom.periodsListContainer;
            container.innerHTML = '';

            const selectedMonthValue = dom.monthFilter.value; // "00" to "11" or ""
            const selectedYearValue = dom.yearFilter.value;   // "YYYY" or ""
            let filteredPeriods = allPeriods;

            console.log(`Filter diterapkan (renderPeriodsList): Bulan = ${selectedMonthValue}, Tahun = ${selectedYearValue}`);

            if (selectedMonthValue !== "" || selectedYearValue !== "") {
                filteredPeriods = allPeriods.filter(period => {
                    // Gunakan properti displayMonthYear untuk pemfilteran
                    const periodDisplayMonthYear = period.displayMonthYear; // Format: "YYYY-MM"
                    
                    // Jika displayMonthYear tidak ada (data lama), kita bisa memilih untuk menampilkannya
                    // atau mengabaikannya. Untuk saat ini, kita akan mengabaikannya jika tidak ada.
                    if (!periodDisplayMonthYear) {
                        return false; 
                    }

                    const [displayYear, displayMonth] = periodDisplayMonthYear.split('-').map(Number); // displayMonth is 0-indexed

                    let monthMatches = true;
                    let yearMatches = true;

                    if (selectedMonthValue !== "") {
                        monthMatches = displayMonth === parseInt(selectedMonthValue, 10);
                    }
                    if (selectedYearValue !== "") {
                        yearMatches = displayYear === parseInt(selectedYearValue, 10);
                    }
                    
                    const matches = monthMatches && yearMatches;
                    console.log(`  Memeriksa periode: ${period.startDate} - ${period.endDate}. Display Month/Year: ${periodDisplayMonthYear}. Filter: ${selectedMonthValue}/${selectedYearValue}. Cocok: ${matches}`);
                    return matches;
                });
            }

            if (filteredPeriods.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 text-sm">Belum ada periode yang ditambahkan untuk bulan dan tahun yang dipilih.</p>';
                return;
            }
            const sortedPeriods = [...filteredPeriods].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            sortedPeriods.forEach(period => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-800 p-2 rounded';
                const startDate = new Date(period.startDate + 'T00:00:00').toLocaleDateString('id-ID');
                const endDate = new Date(period.endDate + 'T00:00:00').toLocaleDateString('id-ID');
                item.innerHTML = `
                    <div>
                        <p class="font-semibold">Periode Rekap</p> 
                        <p class="text-xs text-gray-400">${startDate} s/d ${endDate}</p>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" class="p-2 text-red-500 hover:bg-gray-700 rounded-full delete-period-btn" data-id="${period.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                    </div>
                `;
                container.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderHolidaysList() {
            const container = dom.holidaysListContainer;
            container.innerHTML = '';

            const selectedMonth = dom.monthFilter.value;
            const selectedYear = dom.yearFilter.value;
            let filteredHolidays = allHolidays;

            if (selectedMonth !== "" || selectedYear !== "") {
                filteredHolidays = allHolidays.filter(holiday => {
                    const holidayDate = new Date(holiday.date + 'T00:00:00');
                    let matchMonth = true;
                    let matchYear = true;

                    if (selectedMonth !== "") {
                        const monthIndex = parseInt(selectedMonth, 10);
                        matchMonth = holidayDate.getMonth() === monthIndex;
                    }

                    if (selectedYear !== "") {
                        const yearNum = parseInt(selectedYear, 10);
                        matchYear = holidayDate.getFullYear() === yearNum;
                    }
                    
                    return matchMonth && matchYear;
                });
            }

            if (filteredHolidays.length > 0) {
                filteredHolidays.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA - dateB !== 0) return dateA - dateB;

                    const timeOrder = { "Pagi": 1, "Sore": 2, "Pagi & Sore": 3 };
                    return (timeOrder[a.time] || 0) - (timeOrder[b.time] || 0);
                }).forEach(holiday => createHolidayListItem(holiday.date, holiday.time));
            } else {
                 dom.holidaysListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">Belum ada tanggal libur untuk bulan dan tahun yang dipilih.</p>';
            }
        }

        function createHolidayListItem(dateString, time = "") {
            if (!dateString) return;
            
            const placeholder = dom.holidaysListContainer.querySelector('p');
            if(placeholder) placeholder.remove();

            const existingHolidays = Array.from(dom.holidaysListContainer.querySelectorAll('.holiday-item')).map(item => ({
                date: item.dataset.date,
                time: item.dataset.time || ""
            }));

            const isDuplicate = existingHolidays.some(h => h.date === dateString && h.time === time);
            if (isDuplicate) { showToast("Tanggal libur dengan waktu yang sama sudah ada di daftar.", true); return; }

            const item = document.createElement('div');
            item.className = 'flex justify-between items-center bg-gray-700 p-2 rounded holiday-item';
            item.dataset.date = dateString;
            item.dataset.time = time;
            
            const date = new Date(dateString + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            let displayTime = "";
            if (time === "Pagi") displayTime = " (Pagi)";
            else if (time === "Sore") displayTime = " (Sore)";
            else if (time === "Pagi & Sore") displayTime = " (Pagi & Sore)";

            item.innerHTML = `<span class="text-sm">${formattedDate}${displayTime}</span><button type="button" class="p-1 text-red-500 hover:bg-gray-600 rounded-full remove-holiday-btn"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>`;
            dom.holidaysListContainer.appendChild(item);
            lucide.createIcons();
        }

        // --- Core Logic ---
        async function handleAddPeriod(e) {
            e.preventDefault();
            const startDate = dom.periodStartDate.value;
            const endDate = dom.periodEndDate.value;
            if (!startDate || !endDate) { showToast("Semua field harus diisi.", true); return; }
            if (new Date(startDate) > new Date(endDate)) { showToast("Tanggal Mulai tidak boleh setelah Tanggal Akhir.", true); return; }
            
            const startMonth = new Date(startDate + 'T00:00:00').toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const name = `Rekap ${startMonth}`; 

            // Dapatkan bulan dan tahun yang sedang dipilih di filter
            const selectedMonthForSave = dom.monthFilter.value;
            const selectedYearForSave = dom.yearFilter.value;
            const displayMonthYear = `${selectedYearForSave}-${selectedMonthForSave}`;


            try {
                // Simpan properti displayMonthYear baru
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'recapPeriods'), { 
                    name, 
                    startDate, 
                    endDate,
                    displayMonthYear // Simpan bulan dan tahun yang sedang aktif di filter
                });
                showToast("Periode berhasil ditambahkan.");
                dom.addPeriodForm.reset();
            } catch (error) { showToast("Gagal menyimpan periode.", true); }
        }
        
        async function handleDeletePeriod(id) {
            showCustomConfirm("Apakah Anda yakin ingin menghapus periode ini?", async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recapPeriods', id));
                    showToast("Periode berhasil dihapus.");
                } catch (error) { showToast("Gagal menghapus periode.", true); }
            });
        }

        async function handleSaveHolidays() {
            const button = dom.saveHolidaysBtn;
            button.disabled = true;
            button.innerHTML = `<span>Menyimpan...</span>`;

            const holidayDates = Array.from(dom.holidaysListContainer.querySelectorAll('.holiday-item')).map(item => ({
                date: item.dataset.date,
                time: item.dataset.time || ""
            }));

            try {
                const holidayDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'holidays');
                await setDoc(holidayDocRef, { dates: holidayDates });
                showToast("Daftar hari libur berhasil disimpan.");
            } catch (error) {
                console.error("Error saving holidays:", error);
                showToast("Gagal menyimpan hari libur.", true);
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="save" class="w-4 h-4 mr-2"></i><span>Simpan Tanggal Libur</span>`;
                lucide.createIcons();
            }
        }

        // --- UI Helpers ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            if (!toast || !toastMessage) return;
            toastMessage.textContent = message;
            toast.className = `toast ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function showCustomConfirm(message, onConfirm) {
            const modalHtml = `
                <div id="customConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <p class="text-white text-lg mb-4">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirmYes" class="btn btn-primary">Ya</button>
                            <button id="confirmNo" class="btn btn-secondary">Tidak</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('customConfirmModal');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            confirmYes.addEventListener('click', () => {
                onConfirm();
                modal.remove();
            });

            confirmNo.addEventListener('click', () => {
                modal.remove();
            });
        }


        // --- Event Listeners ---
        dom.addPeriodForm.addEventListener('submit', handleAddPeriod);
        dom.periodsListContainer.addEventListener('click', (e) => {
            if (e.target.closest('.delete-period-btn')) handleDeletePeriod(e.target.closest('.delete-period-btn').dataset.id);
        });
        dom.addHolidayBtn.addEventListener('click', () => {
            const dateValue = dom.newHolidayDate.value;
            const isMorning = dom.holidayMorning.checked;
            const isAfternoon = dom.holidayAfternoon.checked;

            if (!dateValue) { showToast("Silakan pilih tanggal.", true); return; }

            let time = "";
            if (isMorning && isAfternoon) {
                time = "Pagi & Sore";
            } else if (isMorning) {
                time = "Pagi";
            } else if (isAfternoon) {
                time = "Sore";
            }

            createHolidayListItem(dateValue, time);
            dom.newHolidayDate.value = '';
            dom.holidayMorning.checked = false;
            dom.holidayAfternoon.checked = false;
        });
        dom.holidaysListContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-holiday-btn')) { e.target.closest('.holiday-item').remove(); }
        });
        dom.saveHolidaysBtn.addEventListener('click', handleSaveHolidays);
        
        // Event listener for the new "Setel" button
        dom.setFilterBtn.addEventListener('click', () => {
            // Save current filter selections to localStorage
            localStorage.setItem('selectedMonthFilter', dom.monthFilter.value);
            localStorage.setItem('selectedYearFilter', dom.yearFilter.value);
            
            // Apply filters
            renderPeriodsList();
            renderHolidaysList();
        });

        // --- Initial Setup ---
        lucide.createIcons();
        window.addEventListener('beforeunload', () => {
            Object.values(unsubscribes).forEach(unsub => unsub && unsub());
        });
    </script>
</body>
</html>
